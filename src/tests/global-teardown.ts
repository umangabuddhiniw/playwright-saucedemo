// src/tests/global-teardown.ts
import { generateReports, getCombinedStats } from '../utils/results-collector';
import { logger } from '../utils/logger';

export default async function globalTeardown(): Promise<void> {
  try {
    console.log('ğŸ”š Global teardown: Starting final cleanup...');
    
    // Note: Reports are now automatically generated by TestRunner reporter
    // We just log the final status
    
    const stats = getCombinedStats();
    console.log('ğŸ“ˆ Final Test Statistics:', JSON.stringify(stats, null, 2));

    // Log the directory structure
    console.log(`
ğŸ“ Final Test Results Directory Structure:
test-results/
â”œâ”€â”€ reports/                       # âœ… HTML and JSON reports
â”‚   â”œâ”€â”€ test-report-*.html
â”‚   â””â”€â”€ test-report-*.json
â”œâ”€â”€ logs/                          # Winston logs
â”‚   â”œâ”€â”€ debug.log
â”‚   â”œâ”€â”€ errors.log
â”‚   â””â”€â”€ test-execution.log
â”œâ”€â”€ screenshots/                   # Manual screenshots
â”‚   â””â”€â”€ *.png
â”œâ”€â”€ *-video-*/                     # Video recordings
â”‚   â””â”€â”€ video.webm
â””â”€â”€ test-results.json              # JSON test results

playwright-report/                 # âœ… HTML reports (alternative location)
â”œâ”€â”€ data/
â”œâ”€â”€ index.html
â””â”€â”€ trace/
    `);

    logger.info('Global teardown completed', {
      totalTests: stats.combined.totalTests,
      successRate: stats.combined.successRate,
      environment: stats.combined.environment,
      timestamp: new Date().toISOString()
    });

    console.log('âœ… Global teardown completed successfully');

  } catch (error) {
    console.error('âŒ Global teardown failed:', error);
    logger.error('Global teardown failed', {
      error: error instanceof Error ? error.message : 'Unknown error'
    });
    
    // Ensure process exits with error code in CI
    if (process.env.CI) {
      process.exit(1);
    }
  }
}